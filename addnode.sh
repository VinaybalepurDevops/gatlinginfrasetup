#!/bin/bash
len="$(terraform output -json ip | jq length)"
> nodes.txt
a=0
for (( i=0; i<"$len"; i++ ))
do
    
	ip=$(terraform output -json ip | jq -r .["$i"])
	a=$((a+1))
    nodeName=node$i
    echo $nodeName >> nodes.txt
    echo $nodeName
    curl -i 'http://'$1':8080/computer/doCreateItem?name='$nodeName'&type=hudson.slaves.DumbSlave' --user admin:11eb8a9b6c4c661fc24933123036d5c746  -X POST -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:109.0) Gecko/20100101 Firefox/114.0' -H 'Accept: text/html,application/xhtml xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8' -H 'Accept-Language: en-US,en;q=0.5' -H 'Accept-Encoding: gzip, deflate' -H 'Referer: http://'$1':8080/computer/createItem' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: http://'$1':8080' -H 'Connection: keep-alive' -H 'Upgrade-Insecure-Requests: 1' -H 'Pragma: no-cache' -H 'Cache-Control: no-cache' --data-raw 'name="'$nodeName'"&nodeDescription=&_.numExecutors=1&_.remoteFS=/home/ubuntu&_.labelString=slave1&mode=EXCLUSIVE&stapler-class=hudson.slaves.JNLPLauncher&$class=hudson.slaves.JNLPLauncher&_.workDirPath=&_.internalDir=remoting&_.tunnel=&stapler-class=hudson.plugins.sshslaves.SSHLauncher&$class=hudson.plugins.sshslaves.SSHLauncher&_.host='$ip'&includeUser=false&_.credentialsId=c997c8a7-162a-407d-a4c4-277d09e76be3&stapler-class=hudson.plugins.sshslaves.verifiers.KnownHostsFileKeyVerificationStrategy&$class=hudson.plugins.sshslaves.verifiers.KnownHostsFileKeyVerificationStrategy&stapler-class=hudson.plugins.sshslaves.verifiers.ManuallyProvidedKeyVerificationStrategy&$class=hudson.plugins.sshslaves.verifiers.ManuallyProvidedKeyVerificationStrategy&stapler-class=hudson.plugins.sshslaves.verifiers.ManuallyTrustedKeyVerificationStrategy&$class=hudson.plugins.sshslaves.verifiers.ManuallyTrustedKeyVerificationStrategy&stapler-class=hudson.plugins.sshslaves.verifiers.NonVerifyingKeyVerificationStrategy&$class=hudson.plugins.sshslaves.verifiers.NonVerifyingKeyVerificationStrategy&_.port=22&_.javaPath=&_.jvmOptions=&_.prefixStartSlaveCmd=&_.suffixStartSlaveCmd=&launchTimeoutSeconds=&maxNumRetries=&retryWaitTime=&tcpNoDelay=on&workDir=&stapler-class=hudson.slaves.RetentionStrategy$Always&$class=hudson.slaves.RetentionStrategy$Always&retentionStrategy.startTimeSpec=&retentionStrategy.upTimeMins=&retentionStrategy.keepUpWhenActive=on&stapler-class=hudson.slaves.SimpleScheduledRetentionStrategy&$class=hudson.slaves.SimpleScheduledRetentionStrategy&stapler-class=hudson.slaves.RetentionStrategy$Demand&$class=hudson.slaves.RetentionStrategy$Demand&stapler-class-bag=true&type=hudson.slaves.DumbSlave&Submit=&Jenkins-Crumb=c4cd2ff85ba807adba1bcb1ec72171f273bea4192cf1ac64b8528d2cae6a6e77&json={"name": "'$nodeName'", "nodeDescription": "", "numExecutors": "1", "remoteFS": "/home/ubuntu", "labelString": "'$nodeName'", "mode": "EXCLUSIVE", "": ["hudson.plugins.sshslaves.SSHLauncher", "0"], "launcher": {"stapler-class": "hudson.plugins.sshslaves.SSHLauncher", "$class": "hudson.plugins.sshslaves.SSHLauncher", "host": '$ip', "includeUser": "false", "credentialsId": "c997c8a7-162a-407d-a4c4-277d09e76be3", "": "3", "sshHostKeyVerificationStrategy": {"stapler-class": "hudson.plugins.sshslaves.verifiers.NonVerifyingKeyVerificationStrategy", "$class": "hudson.plugins.sshslaves.verifiers.NonVerifyingKeyVerificationStrategy"}, "port": "22", "javaPath": "", "jvmOptions": "", "prefixStartSlaveCmd": "", "suffixStartSlaveCmd": "", "launchTimeoutSeconds": "", "maxNumRetries": "", "retryWaitTime": "", "tcpNoDelay": true, "workDir": ""}, "retentionStrategy": {"stapler-class": "hudson.slaves.RetentionStrategy$Always", "$class": "hudson.slaves.RetentionStrategy$Always"}, "nodeProperties": {"stapler-class-bag": "true"}, "type": "hudson.slaves.DumbSlave", "Submit": ""}'
done
